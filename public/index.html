<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
    <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
    }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>

    function initMap() {
      navigator.geolocation.getCurrentPosition(function(position) {
        var position = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        window.map = new google.maps.Map(document.getElementById('map'), {
          center: position, zoom: 16
        });

        var source   = $("#label-template").html();
        var template = Handlebars.compile(source);

        $.ajax({
          url: "/pokemons",
          data: position,
          success: function(result) {
            result.pokemons.map(function(pokemon) {
              var icon = 'img/icons/' + pokemon.id+ '.png';
              var position = new google.maps.LatLng(pokemon.latitude, pokemon.longitude);
              var info = new google.maps.InfoWindow({
                content: template({
                  name: pokemon.name,
                  disappear_time: pokemon.expire / 1000 / 60
                })
              });
              var marker = new google.maps.Marker({
                position: position, map: map, icon: icon,
              });
              marker.addListener('click', function() {
                info.open(map, marker);
              });
            });
          }
        });
      });
    }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALXyMXFNOtTS0JOkl_-hsO84LfOypgoQA&callback=initMap" async defer></script>
    <script id="label-template" type="text/x-handlebars-template">
      <div>
        <h5>{{name}}</h5>
        <p>disappears in <span>{{disappear_time}}</span></p>
      </div>
    </script>
  </body>
</html>
